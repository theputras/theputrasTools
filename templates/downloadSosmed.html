<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Downloader Social Media</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-gray-900 text-gray-300 font-sans">
    
    <div 
      class="container mx-auto p-6 pb-20" 
      x-data="downloader()"
    >
        <h1 class="text-2xl font-semibold text-white mb-6">Sosmed Downloader</h1>
        <a href="/tools" class="text-blue-400 hover:text-blue-300 mb-4 inline-block">&laquo; Back to Tools</a>
        
        <div class="bg-gray-800 rounded-lg shadow-md p-6">
            <div class="flex space-x-4">
  
                <input 
                  type="text" 
                  x-model="url"
                  @keydown.enter="handleSubmit"
                  placeholder="Tempel link YouTube..."
                  class="flex-1 px-4 py-2 bg-gray-700 text-white border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <button
                  @click="handleSubmit"
                  :disabled="loading || !url"
                  class="flex justify-center items-center px-6 py-2 bg-blue-600 text-white rounded-md font-semibold hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <svg x-show="loading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" ...>...</svg>
                    <span x-text="loading ? 'Mengecek...' : 'Cek Link'"></span>
                </button>
            </div>
            <template x-if="error">
                <p x-text="error" class="text-red-400 text-sm mt-4"></p>
            </template>
        </div>
<!-- Peringatan Refresh -->
<template x-if="progress.active">
    <div class="bg-yellow-500 text-black p-4 rounded-md mt-4">
        <p>Proses download atau konversi sedang berjalan. Jika Anda refresh, proses ini akan terhenti!</p>
    </div>
</template>


            <!-- PROGRESS AREA -->
<div x-show="progress.active" class="mt-4 transition-all bg-gray-800 rounded-lg shadow-md p-6">
    <div class="flex justify-between mb-1">
        <span class="text-sm font-medium text-blue-400" x-text="progress.statusText">Downloading...</span>
        <span class="text-sm font-medium text-blue-400" x-text="Math.round(progress.value) + '%'"></span>
    </div>
    
    <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
        <div class="h-3 transition-all duration-300"
             :class="progress.statusText === 'Converting' ? 'bg-yellow-500 animate-pulse' : 'bg-blue-500'"
             :style="`width: ${progress.value}%`">
        </div>
    </div>
    
    <p class="text-xs text-gray-400 mt-2 font-mono" x-text="progress.detailText"></p>
</div>
        
<!-- Placeholder untuk Instagram, TikTok, Facebook, Twitter, Dailymotion -->
<template x-if="result && !result.success && result.platform">
    <div class="mt-6 bg-gray-800 rounded-lg shadow-md p-6 text-center animate-fade-in">
        
        <h3 class="text-lg font-semibold text-white mb-2"
            x-text="result.platform.toUpperCase()">
        </h3>

        <p class="text-gray-400 mb-4">
            Downloader untuk platform ini belum diaktifkan.
        </p>

        <div class="space-y-2">
            <button class="w-full py-2 bg-gray-700 text-gray-300 rounded-md cursor-not-allowed">
                Download Video (coming soon)
            </button>
            <button class="w-full py-2 bg-gray-700 text-gray-300 rounded-md cursor-not-allowed">
                Download Audio (coming soon)
            </button>
        </div>

    </div>
</template>

        <template x-if="result && result.success">
            <div class="mt-6 bg-gray-800 rounded-lg shadow-md overflow-hidden animate-fade-in">
                
                <div class="p-6">
                    <div class="flex flex-col sm:flex-row sm:items-start gap-4">
                        <img :src="result.thumbnail" alt="Thumbnail" class="w-full sm:w-48 rounded-md object-cover shadow-lg">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-white" x-text="result.title"></h3>
                            <p class="text-sm text-gray-400 mt-2">
                                Pilih resolusi/kualitas, lalu pilih format konversi.
                                <strong class="text-yellow-400">Proses ini lambat dan makan CPU server!</strong>
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="border-t border-gray-700">
                    <h4 class="text-base font-semibold text-white p-4">Opsi Video</h4>
                    <div class="divide-y divide-gray-700">
                        <template x-for="q in result.video_qualities" :key="q">
                            <div class="p-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                                <p class="font-medium text-white" x-text="q"></p>
                                <div class="flex flex-wrap gap-2">
                                    <button @click="startConversion('mp4', q)" :disabled="converting" class="flex items-center justify-center px-3 py-1.5 bg-gray-600 text-white text-xs font-medium rounded-md hover:bg-gray-500 disabled:opacity-50">
                                        <svg x-show="converting === 'mp4' + q" class="animate-spin -ml-1 mr-2 h-4 w-4" ...>...</svg>
                                        <span x-text="converting === 'mp4' + q ? 'Proses...' : 'MP4'"></span>
                                    </button>
                                    <button @click="startConversion('mkv', q)" :disabled="converting" class="flex items-center justify-center px-3 py-1.5 bg-gray-600 text-white text-xs font-medium rounded-md hover:bg-gray-500 disabled:opacity-50">
                                        <svg x-show="converting === 'mkv' + q" class="animate-spin -ml-1 mr-2 h-4 w-4" ...>...</svg>
                                        <span x-text="converting === 'mkv' + q ? 'Proses...' : 'MKV'"></span>
                                    </button>
                                    <button @click="startConversion('mpeg', q)" :disabled="converting" class="flex items-center justify-center px-3 py-1.5 bg-gray-600 text-white text-xs font-medium rounded-md hover:bg-gray-500 disabled:opacity-50">
                                        <svg x-show="converting === 'mpeg' + q" class="animate-spin -ml-1 mr-2 h-4 w-4" ...>...</svg>
                                        <span x-text="converting === 'mpeg' + q ? 'Proses...' : 'MPEG'"></span>
                                    </button>
                                     <button @click="startConversion('webm_video', q)" :disabled="converting" class="flex items-center justify-center px-3 py-1.5 bg-gray-600 text-white text-xs font-medium rounded-md hover:bg-gray-500 disabled:opacity-50">
                                        <svg x-show="converting === 'webm_video' + q" class="animate-spin -ml-1 mr-2 h-4 w-4" ...>...</svg>
                                        <span x-text="converting === 'webm_video' + q ? 'Proses...' : 'WEBM'"></span>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <div class="border-t border-gray-700">
                    <h4 class="text-base font-semibold text-white p-4">Opsi Audio</h4>
                     <div class="divide-y divide-gray-700">
                        <template x-for="q in result.audio_qualities" :key="q.id">
                            <div class="p-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                                <p class="font-medium text-white" x-text="q.label"></p>
                                <div class="flex flex-wrap gap-2">
                                    <button @click="startConversion('mp3', q.id)" :disabled="converting" class="flex items-center justify-center px-3 py-1.5 bg-gray-600 text-white text-xs font-medium rounded-md hover:bg-gray-500 disabled:opacity-50">
                                        <svg x-show="converting === 'mp3' + q.id" class="animate-spin -ml-1 mr-2 h-4 w-4" ...>...</svg>
                                        <span x-text="converting === 'mp3' + q.id ? 'Proses...' : 'MP3'"></span>
                                    </button>
                                    <button @click="startConversion('wav', q.id)" :disabled="converting" class="flex items-center justify-center px-3 py-1.5 bg-gray-600 text-white text-xs font-medium rounded-md hover:bg-gray-500 disabled:opacity-50">
                                        <svg x-show="converting === 'wav' + q.id" class="animate-spin -ml-1 mr-2 h-4 w-4" ...>...</svg>
                                        <span x-text="converting === 'wav' + q.id ? 'Proses...' : 'WAV'"></span>
                                    </button>
                                    <button @click="startConversion('webm_audio', q.id)" :disabled="converting" class="flex items-center justify-center px-3 py-1.5 bg-gray-600 text-white text-xs font-medium rounded-md hover:bg-gray-500 disabled:opacity-50">
                                        <svg x-show="converting === 'webm_audio' + q.id" class="animate-spin -ml-1 mr-2 h-4 w-4" ...>...</svg>
                                        <span x-text="converting === 'webm_audio' + q.id ? 'Proses...' : 'WEBM'"></span>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
            </div>
        </template>
        
    </div>

    <!-- {% include 'nativeNav.html' %} -->

    <script>
        document.addEventListener('alpine:init', () => {
      Alpine.data('downloader', () => ({
                url: '',
                loading: false,
                converting: null, // Untuk disable tombol spesifik
                error: null,
                result: null,
                eventSource: null, // Simpan koneksi SSE

                progress: {
                    active: false,
                    value: 0,
                    statusText: 'Menunggu...',
                    detailText: ''
                },
                init() {
                    // 1. Event Listener: Saat user mau refresh/close tab
                    window.addEventListener('beforeunload', (e) => {
                        if (this.progress.active) {
                            // Munculkan alert bawaan browser
                            e.preventDefault();
                            e.returnValue = 'Proses download sedang berjalan. Yakin ingin membatalkan?';
                        }
                    });

                    // 2. Event Listener: Saat user BENAR-BENAR pergi (klik Yes)
                    window.addEventListener('pagehide', () => {
                        if (this.progress.active && this.currentTaskId) {
                            this.killTask(this.currentTaskId);
                        }
                    });
                },

                // Fungsi untuk mengirim sinyal mati ke backend
                killTask(taskId) {
                    const data = JSON.stringify({ task_id: taskId });
                    // Gunakan sendBeacon karena fetch biasa sering gagal saat tab ditutup
                    navigator.sendBeacon('/api/cancel-task', data);
                },

getPlatform(url) {
    url = url.toLowerCase();

    if (url.includes('youtube.com') || url.includes('youtu.be')) return 'youtube';
    if (url.includes('instagram.com')) return 'instagram';
    if (url.includes('tiktok.com')) return 'tiktok';
    if (url.includes('facebook.com') || url.includes('fb.watch')) return 'facebook';
    if (url.includes('twitter.com') || url.includes('x.com')) return 'twitter';
    if (url.includes('dailymotion.com') || url.includes('dai.ly')) return 'dailymotion';

    return 'unknown';
},
        // Mulai mendengarkan SSE
// --- FUNGSI BARU: Listen progress berdasarkan Task ID ---
                startListeningToProgress(taskId) {
    if (this.eventSource) {
        this.eventSource.close();
    }
this.currentTaskId = taskId; // Simpan ID
    this.progress.active = true;
    this.progress.value = 0;
    this.progress.statusText = "Menghubungkan...";
    this.progress.detailText = "Mencari sinyal..."; // Ubah teks biar kelihatan beda

    console.log("Memulai SSE ke:", `/api/progress/${taskId}`); // DEBUG 1

    this.eventSource = new EventSource(`/api/progress/${taskId}`);
    
    this.eventSource.onmessage = (event) => {
        // DEBUG 2: Cek apa data masuk ke browser?
        console.log("Data SSE Masuk:", event.data); 

        try {
            const data = JSON.parse(event.data);

            if (data.status === 'Finished') {
                this.progress.value = 100;
                this.progress.statusText = "Selesai!";
                this.eventSource.close();
                this.currentTaskId = null; // Clear ID
                return;
            }

            if (data.status === 'Error') {
                this.error = `Error: ${data.message}`;
                this.progress.active = false;
                this.eventSource.close();
                this.currentTaskId = null; // Clear ID
                return;
            }

            // Update tampilan
            this.progress.value = parseFloat(data.progress) || 0; // Pastikan float
            this.progress.statusText = data.status;

            if (data.status === 'Downloading') {
                this.progress.detailText = `Speed: ${data.speed} | Size: ${data.size} | ETA: ${data.eta}`;
            } else if (data.status === 'Converting') {
               this.progress.detailText = data.text || "Sedang memproses konversi format (Mohon tunggu)...";
                        } else {
                            this.progress.detailText = "";
                        }
        } catch (e) {
            console.error("Error parsing JSON:", e);
        }
    };

    this.eventSource.onerror = (err) => {
        console.log("Koneksi SSE bermasalah (mungkin selesai/putus).");
    };
},

        checkProgressOnLoad() {
            const storedProgress = JSON.parse(sessionStorage.getItem('progress_active'));
            if (storedProgress && storedProgress.active) {
                this.progress.active = true;
                this.progress.value = storedProgress.progress;
                this.progress.text = `Download masih berjalan: ${this.progress.value}%`;
            }
        },
                // 1. FUNGSI "CEK LINK" (API CEPAT)
                async handleSubmit() {
                    this.loading = true;
                    this.error = null;
                    this.result = null;

                        const platform = this.getPlatform(this.url);
    if (platform === 'unknown') {
        this.error = 'Link tidak dikenali. Tempel link YouTube / Instagram / TikTok / Facebook / Twitter / Dailymotion.';
        this.loading = false;
        return;
    }

    // YOUTUBE
    if (platform === 'youtube') {
                    try {
                        // Panggil API Cepat buat dapet info
                        const response = await fetch('/api/get-youtube-info', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ url: this.url })
                        });
                        const data = await response.json();
                        if (!response.ok || data.error) throw new Error(data.error);
                        
                        this.result = data; // Tampilkan list tombol

                    } catch (err) {
                        this.error = err.message;
                    } finally {
                        this.loading = false;
                    }
                    return;
                }
                    // PLATFORM LAIN (placeholder dulu)
    this.loading = false;
    this.result = {
        success: false,
        platform: platform
    };
            },
            
                // 2. FUNGSI "KONVERSI" (API LAMBAT)
                async startConversion(ext, quality) {
                    if (!this.url) return;
                    
                    this.converting = ext + quality; // Set loading di tombol ini
                  this.error = null;

                    // GENERATE UUID di Frontend
                    const taskId = crypto.randomUUID(); 
                    console.log('Task ID:', taskId);
                    // Langsung mulai dengarkan progress SEBELUM request dikirim
                    this.startListeningToProgress(taskId);

                    try {
                            
                        // Panggil API Lambat (konversi)
                        const response = await fetch('/api/request-conversion', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                           body: JSON.stringify({ 
                                url: this.url, 
                                ext: ext, 
                                quality: quality,
                                task_id: taskId // <-- PENTING: Kirim ID ke backend
                            })
                        });
                        const data = await response.json();
                        // Tutup koneksi SSE karena proses backend sudah selesai (return success)
                        if (this.eventSource) this.eventSource.close();
                        this.currentTaskId = null; // Tugas selesai
                        if (!response.ok || data.error) {
                            throw new Error(data.error || 'Konversi gagal.');
                        }
        // STEP 2 â€” Finalize progress
        this.progress.value = 100;
                        this.progress.statusText = "Mengunduh File...";
                        // Sukses! Trigger download
                        const link = document.createElement('a');
                        link.href = data.download_url;
                        link.setAttribute('download', data.download_as);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
// Reset tampilan setelah 3 detik
                        setTimeout(() => {
                            this.progress.active = false;
                            this.converting = false;
                        }, 3000);
                        
                    } catch (err) {
                        this.error = err.message; // Tampilkan error di box global
                        this.progress.active = false;
                        this.converting = false;
                        this.currentTaskId = null;
                        if (this.eventSource) this.eventSource.close();
                    } finally {
                        this.converting = null; // Selesai loading
                    }
                },
                
                

            }));
        });

                // Nambahin style buat animasi fade-in
        const style = document.createElement('style');
        style.innerHTML = `
            .animate-fade-in {
                animation: fadeIn 0.5s ease-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>